#!/bin/bash

# Configure the (immutable) Docker image for the service.
# Command-line arguments: PROJECT, ENV (e.g. dev or prod), AWS_REGION (e.g. us-east-1),
#   IMAGE_LABEL
# All actions are local to the VM; does not use aws or ecs-cli. TODO: ???
# Should be run before deploy-to-ecs is run and after package-for-ecs is run.
# Assumes it is run in the -ecs directory.

# Fail on any error; unset variables are errors; show commands before executing:
set -eux

PROJECT="$1"   ### not currently actually USED
ENV="$2"
aws_region="$3"
image_label="$4"
if [ $image_label != latest ]; then
  image_label=${image_label:0:7}
fi

echo "=== configure-for-ecs: $ENV ==="
date
echo "Running in $PWD"
echo "Project = $PROJECT"
echo "Target Environment = $ENV"
echo "AWS region = $aws_region"
echo "Image Label = $image_label"
echo

#### Configuration:

# Find out what the external FQDN of the Application Load Balancer (ALB) is;
# change the domain line in wherever ../src/environments/environment.[prod.]ts ends up to
# use that instead of localhost; e.g.:
# const domain = 'tcp-testing-3-dev-cluster-alb-877192071.us-east-1.elb.amazonaws.com:8080'

WEB_DOMAIN=$(aws ssm get-parameter --region $aws_region --name "/$PROJECT/$ENV/alb/endpoint" --query "Parameter.Value" --out text)
echo "ALB FQDN is $WEB_DOMAIN"

# Use the below if using a DNS registered in Route53 (or other DNS provider)
#if [ $ENV == prod ]; then
#    WEB_DOMAIN='2020counts.org:8080'
#else
#    WEB_DOMAIN='dev.2020counts.org:8080'
#fi

# Depends on IMAGE_REPO=${image_repo} already being in the ../.env file (put there by package-for-ecs)
# Note: do NOT use double-quotes around the values; bash isn't interpreting .env: ecs-cli compose is, and it does not drop quotes.
ECS_DIR=.
echo "Generating .env file for ECS deployment..."
# Start with .env file in parent directory, or empty file if that doesn't exist:
echo -n "" > $ECS_DIR/.env
cp -p ../.env $ECS_DIR/ ||:

cat >> $ECS_DIR/.env <<EOF
# Generated by configure-for-ecs $(date)
IMAGE_LABEL=${image_label}
AWS_REGION=${aws_region}
WEB_DOMAIN=${WEB_DOMAIN}
TIMESTAMP='$(date)'
EOF

#### DEBUGGING:
echo ".env file for ECS deployment to $ENV:"
cat $ECS_DIR/.env
echo "--------"

date
